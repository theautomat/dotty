{"version":3,"file":"firebase-service-DQQuUGs_.js","sources":["../../scripts/firebase-service.js"],"sourcesContent":["/**\n * Firebase Service - Game data storage and analytics\n * \n * This service handles saving game statistics to Cloud Firestore\n * and tracking analytics events.\n */\nimport { initializeFirebase } from './firebase-module.js';\nimport { collection, addDoc, doc, setDoc } from 'firebase/firestore';\nimport { logEvent } from 'firebase/analytics';\n\nclass FirebaseService {\n  constructor() {\n    this.initialized = false;\n    this.app = null;\n    this.db = null;\n    this.analytics = null;\n  }\n\n  /**\n   * Initialize Firebase services\n   * @returns {Promise<boolean>} Success status\n   */\n  async initialize() {\n    if (this.initialized) return true;\n\n    try {\n      // Initialize Firebase through our centralized module\n      const firebase = initializeFirebase();\n      \n      // Store references\n      this.app = firebase.app;\n      this.db = firebase.db;\n      this.analytics = firebase.analytics;\n      \n      // Set initialized flag\n      this.initialized = true;\n      \n      // Just log the database instance for debugging\n      console.log('Cloud Firestore initialized successfully');\n      \n      return true;\n    } catch (error) {\n      console.error('CRITICAL: Firebase initialization failed:', error);\n      this.initialized = false;\n      return false;\n    }\n  }\n\n  /**\n   * Save game statistics to Firebase\n   * @param {string} fingerprintId - Unique player identifier\n   * @param {Object} stats - Game statistics to save\n   * @returns {Promise<boolean>} Success status\n   */\n  async saveGameStats(fingerprintId, stats) {\n    // Ensure Firebase is initialized\n    if (!this.initialized) {\n      console.log('Firebase not initialized, attempting to initialize now...');\n      const initResult = await this.initialize();\n      if (!initResult) {\n        console.error('Cannot save game stats: Firebase not initialized');\n        return false;\n      }\n    }\n    \n    // Verify Firestore is available\n    if (!this.db) {\n      console.error('Cannot save game stats: Cloud Firestore not available');\n      return false;\n    }\n    \n    try {\n      // Validate player ID\n      if (!fingerprintId || typeof fingerprintId !== 'string' || fingerprintId.length < 5) {\n        console.error('Invalid fingerprint ID for saving game stats:', fingerprintId);\n        return false;\n      }\n      \n      // Use game ID from stats or generate a new one\n      const gameId = stats.gameId || `game_${Date.now()}`;\n      \n      // Prepare data for storage\n      const gameData = {\n        // Game and player identification\n        gameId: gameId,\n        playerId: fingerprintId,\n        \n        // Core stats\n        score: stats.score,\n        asteroidsDestroyed: stats.asteroidsDestroyed,\n        totalOresMined: stats.totalOresMined,\n        gameTime: stats.gameTime,\n        \n        // Level information\n        level: stats.level?.id || 0,\n        levelName: stats.level?.name || '',\n        \n        // Individual ore counts for easier querying\n        oresMined: {\n          iron: stats.oresMined?.iron || 0,\n          copper: stats.oresMined?.copper || 0,\n          silver: stats.oresMined?.silver || 0,\n          gold: stats.oresMined?.gold || 0,\n          platinum: stats.oresMined?.platinum || 0\n        },\n        \n        // Event metadata\n        eventType: stats.eventType || 'unknown',\n        timestamp: new Date().toISOString(),\n        created: Date.now()\n      };\n      \n      // Log what we're saving\n      console.log(`Saving game stats for player ${fingerprintId}, game ${gameId}`);\n      \n      try {\n        // Using Firestore to add document to 'games' collection\n        // We can use either addDoc (auto-generated ID) or setDoc (with custom ID)\n        if (gameId) {\n          // Use setDoc with a specific document ID (gameId)\n          const docRef = doc(this.db, 'games', gameId);\n          await setDoc(docRef, gameData);\n          console.log(`Game stats saved successfully with ID: ${gameId}`);\n        } else {\n          // Use addDoc for auto-generated ID\n          const docRef = await addDoc(collection(this.db, 'games'), gameData);\n          console.log(`Game stats saved successfully with auto ID: ${docRef.id}`);\n        }\n        return true;\n      } catch (writeError) {\n        console.error('Firestore write failed:', writeError);\n        return false;\n      }\n    } catch (error) {\n      console.error('Failed to save game stats:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Track an analytics event\n   * @param {string} eventName - Name of the event\n   * @param {Object} eventParams - Event parameters\n   * @returns {Promise<boolean>} Success status\n   */\n  async trackEvent(eventName, eventParams = {}) {\n    // Non-critical function - wrap in try/catch\n    try {\n      // Skip if analytics is unavailable\n      if (!this.analytics) {\n        console.debug('Analytics not available for event tracking');\n        return false;\n      }\n      \n      // Log the event\n      logEvent(this.analytics, eventName, eventParams);\n      console.debug(`Analytics event tracked: ${eventName}`);\n      return true;\n    } catch (error) {\n      // Just log the error - don't fail the game\n      console.warn('Failed to track analytics event:', error);\n      return false;\n    }\n  }\n}\n\n// Export a singleton instance\nconst firebaseService = new FirebaseService();\nexport default firebaseService;"],"names":["FirebaseService","firebase","initializeFirebase","error","fingerprintId","stats","gameId","gameData","_a","_b","_c","_d","_e","_f","_g","docRef","doc","setDoc","addDoc","collection","writeError","eventName","eventParams","logEvent","firebaseService"],"mappings":"mLAUA,MAAMA,CAAgB,CACpB,aAAc,CACZ,KAAK,YAAc,GACnB,KAAK,IAAM,KACX,KAAK,GAAK,KACV,KAAK,UAAY,IACrB,CAME,MAAM,YAAa,CACjB,GAAI,KAAK,YAAa,MAAO,GAE7B,GAAI,CAEF,MAAMC,EAAWC,EAAoB,EAGrC,YAAK,IAAMD,EAAS,IACpB,KAAK,GAAKA,EAAS,GACnB,KAAK,UAAYA,EAAS,UAG1B,KAAK,YAAc,GAGnB,QAAQ,IAAI,0CAA0C,EAE/C,EACR,OAAQE,EAAO,CACd,eAAQ,MAAM,4CAA6CA,CAAK,EAChE,KAAK,YAAc,GACZ,EACb,CACA,CAQE,MAAM,cAAcC,EAAeC,EAAO,mBAExC,GAAI,CAAC,KAAK,cACR,QAAQ,IAAI,2DAA2D,EAEnE,CADe,MAAM,KAAK,WAAY,GAExC,eAAQ,MAAM,kDAAkD,EACzD,GAKX,GAAI,CAAC,KAAK,GACR,eAAQ,MAAM,uDAAuD,EAC9D,GAGT,GAAI,CAEF,GAAI,CAACD,GAAiB,OAAOA,GAAkB,UAAYA,EAAc,OAAS,EAChF,eAAQ,MAAM,gDAAiDA,CAAa,EACrE,GAIT,MAAME,EAASD,EAAM,QAAU,QAAQ,KAAK,IAAG,CAAE,GAG3CE,EAAW,CAEf,OAAQD,EACR,SAAUF,EAGV,MAAOC,EAAM,MACb,mBAAoBA,EAAM,mBAC1B,eAAgBA,EAAM,eACtB,SAAUA,EAAM,SAGhB,QAAOG,EAAAH,EAAM,QAAN,YAAAG,EAAa,KAAM,EAC1B,YAAWC,EAAAJ,EAAM,QAAN,YAAAI,EAAa,OAAQ,GAGhC,UAAW,CACT,OAAMC,EAAAL,EAAM,YAAN,YAAAK,EAAiB,OAAQ,EAC/B,SAAQC,EAAAN,EAAM,YAAN,YAAAM,EAAiB,SAAU,EACnC,SAAQC,EAAAP,EAAM,YAAN,YAAAO,EAAiB,SAAU,EACnC,OAAMC,EAAAR,EAAM,YAAN,YAAAQ,EAAiB,OAAQ,EAC/B,WAAUC,EAAAT,EAAM,YAAN,YAAAS,EAAiB,WAAY,CACxC,EAGD,UAAWT,EAAM,WAAa,UAC9B,UAAW,IAAI,KAAM,EAAC,YAAa,EACnC,QAAS,KAAK,IAAG,CAClB,EAGD,QAAQ,IAAI,gCAAgCD,CAAa,UAAUE,CAAM,EAAE,EAE3E,GAAI,CAGF,GAAIA,EAAQ,CAEV,MAAMS,EAASC,EAAI,KAAK,GAAI,QAASV,CAAM,EAC3C,MAAMW,EAAOF,EAAQR,CAAQ,EAC7B,QAAQ,IAAI,0CAA0CD,CAAM,EAAE,CACxE,KAAe,CAEL,MAAMS,EAAS,MAAMG,EAAOC,EAAW,KAAK,GAAI,OAAO,EAAGZ,CAAQ,EAClE,QAAQ,IAAI,+CAA+CQ,EAAO,EAAE,EAAE,CAChF,CACQ,MAAO,EACR,OAAQK,EAAY,CACnB,eAAQ,MAAM,0BAA2BA,CAAU,EAC5C,EACf,CACK,OAAQjB,EAAO,CACd,eAAQ,MAAM,6BAA8BA,CAAK,EAC1C,EACb,CACA,CAQE,MAAM,WAAWkB,EAAWC,EAAc,GAAI,CAE5C,GAAI,CAEF,OAAK,KAAK,WAMVC,EAAS,KAAK,UAAWF,EAAWC,CAAW,EAC/C,QAAQ,MAAM,4BAA4BD,CAAS,EAAE,EAC9C,KAPL,QAAQ,MAAM,4CAA4C,EACnD,GAOV,OAAQlB,EAAO,CAEd,eAAQ,KAAK,mCAAoCA,CAAK,EAC/C,EACb,CACA,CACA,CAGK,MAACqB,EAAkB,IAAIxB"}